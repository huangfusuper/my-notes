## 一、概述

长文警告，事实上我不愿意写太长的文章，一面是太冗余，一方面读者容易疲倦，但是只要是涉及到源码级别的，就肯定篇幅不短，因为太短肯定没意义也解释不清楚，但是相信，耐心看完这个文章一定会有所收获！

最近有很多读者面试的时候都被问到了有关于Spring三级缓存的解决方案，很多读者在面试受挫之后，试着自己去读源码，试着去跟断点又发现一层套一层，一会自己就懵了，我这几天总结了一下，为了能够让读者更加的去了解Spring解决循环依赖问题，我决定从以下四个方面去讲述：

1. **什么是循环依赖**
2. **如果不依赖于Spring自己解决循环依赖如何解决？**
3. **自己实现的方式有什么缺陷？**
4. **Spring中是如何解决循环依赖的？**

## 二、什么是循环依赖

循环依赖直白点就是发生在两个类，`你引用我，我引用你`的状态，如图：

![循环依赖示意图](http://images.huangfusuper.cn/typora/0729循环依赖示意图1.png)

## 三、如果不依赖于Spring自己解决循环依赖如何解决

以上图为例，假设，我们能够创建完成`AService`之后，放置到到一个缓存中，再去注入属性！每次注入属性的时候，所需要的属性值都从缓存中获取一遍，缓存中没有再去创建不就解决了？如图所示：

![](http://images.huangfusuper.cn/typora/自己解决循环依赖07292020.png)

总结一下上面的流程：

1. `AService`创建完成后将自己加入到二级缓存，然后开始注入属性
2. 发现`AService`依赖`BService`于是先查询一级缓存是否有数据一级缓存没有就查询二级缓存，有就返回，没有就创建`BService`
3. 缓存中没有，开始实例化`BService`，然后注入内部属性！
4. 注入内部属性时发现依赖`AService`，于是先查询一级缓存是否有数据一级缓存没有就查询二级缓存，有就返回，没有就创建，很显然，二级缓存是有数据的。于是从二级缓存取出`AService`注入到`BService`。
5. `BService`创建完成后将自己从二级缓存挪到一级缓存，并返回。
6. `AService`获取到`BService`后，注入到自己的属性中并把自己从二级缓存挪的一级缓存，返回`AService`!
7. 至此，循环依赖创建完成！

